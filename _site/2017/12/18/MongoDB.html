<h3 id="mongodb基础">MongoDB基础</h3>
<h4 id="连接">连接</h4>
<p>mongo -u data_online -p dataonline –authenticationDatabase data_account –host localhost –port 27017</p>
<h4 id="用户相关">用户相关</h4>
<h5 id="1-添加一个用户">1. 添加一个用户</h5>
<h6 id="用dbcreateuser方法如果用户存在则返回一个用户重复错误">用db.createUser()方法，如果用户存在则返回一个用户重复错误`</h6>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db.createUser(user, writeConcern)
    user: 这个文档创建关于用户的身份认证和访问信息；
    writeConcern: 这个文档描述保证MongoDB提供写操作的成功报告。
</code></pre></div></div>
<blockquote>
  <p>user文档，定义了用户的以下形式：</p>
  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{ user: "&lt;name&gt;",
  pwd: "&lt;cleartext password&gt;",
  customData: { &lt;any information&gt; },
  roles: [
    { role: "&lt;role&gt;", db: "&lt;database&gt;" } | "&lt;role&gt;",
    ...
  ]
}
</code></pre></div>  </div>
  <p>user文档字段介绍：</p>
</blockquote>

<p>user字段，为新用户的名字；
pwd字段，用户的密码；
cusomData字段，为任意内容，例如可以为用户全名介绍；
roles字段，指定用户的角色，可以用一个空数组给新用户设定空角色；
在roles字段,可以指定内置角色和用户定义的角色。</p>

<p>Built-In Roles（内置角色）：</p>
<ol>
  <li>数据库用户角色：read、readWrite;</li>
  <li>数据库管理角色：dbAdmin、dbOwner、userAdmin；</li>
  <li>集群管理角色：clusterAdmin、clusterManager、clusterMonitor、hostManager；</li>
  <li>备份恢复角色：backup、restore；</li>
  <li>所有数据库角色：readAnyDatabase、readWriteAnyDatabase、userAdminAnyDatabase、dbAdminAnyDatabase</li>
  <li>超级用户角色：root<br />
// 这里还有几个角色间接或直接提供了系统超级用户的访问（dbOwner 、userAdmin、userAdminAnyDatabase）</li>
  <li>内部角色：__system
PS：关于每个角色所拥有的操作权限可以点击上面的内置角色链接查看详情。</li>
</ol>

<blockquote>
  <p>writeConcern文档(官方说明):</p>
</blockquote>

<p>w选项：允许的值分别是 1、0、大于1的值、”majority”、<tag set="">；
j选项：确保mongod实例写数据到磁盘上的journal（日志），这可以确保mongd意外关闭不会丢失数据。设置true启用。
wtimeout：指定一个时间限制,以毫秒为单位。wtimeout只适用于w值大于1。</tag></p>
<h5 id="示例">示例:</h5>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>创建：
use data_center
db.createUser( { "user" : "data_online",
                 "pwd": "dataonline",
                 "roles" : [ { role: "clusterAdmin", db: "admin" },
                             { role: "readAnyDatabase", db: "admin" },
                             "readWrite"
                             ] },
               { w: "majority" , wtimeout: 5000 } )
</code></pre></div></div>
<p>验证：
mongo -u data_online -p dataonline –authenticationDatabase data_center</p>
<h6 id="用adduser方法">用addUser方法</h6>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db.addUser("name");
db.addUser("userName", "pwd123", true); 添加用户、设置密码、是否只读
</code></pre></div></div>
<h5 id="2-数据库认证安全模式">2. 数据库认证、安全模式</h5>
<p>db.auth(“userName”, “123123”);</p>
<h5 id="3-显示当前所有用户">3. 显示当前所有用户</h5>
<p>show users;</p>
<h5 id="4-删除用户">4. 删除用户</h5>
<p>db.removeUser(“userName”);</p>
<h4 id="数据库常用命令">数据库常用命令:</h4>
<h5 id="1-help查看命令提示">1. Help查看命令提示</h5>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>help
db.help();
db.yourColl.help();
db.youColl.find().help();
rs.help();
</code></pre></div></div>
<h5 id="2-切换创建数据库">2. 切换/创建数据库</h5>
<p>use yourDB; //当创建一个集合(table)的时候会自动创建当前数据库</p>
<h5 id="3-查询所有数据库">3. 查询所有数据库</h5>
<p>show dbs;</p>
<h5 id="4-删除当前使用数据库">4. 删除当前使用数据库</h5>
<p>db.dropDatabase();</p>
<h5 id="5-从指定主机上克隆数据库">5. 从指定主机上克隆数据库</h5>
<p>db.cloneDatabase(“127.0.0.1”); //将指定机器上的数据库的数据克隆到当前数据库</p>
<h5 id="6-从指定的机器上复制指定数据库数据到某个数据库">6. 从指定的机器上复制指定数据库数据到某个数据库</h5>
<p>db.copyDatabase(“mydb”, “temp”, “127.0.0.1”);将本机的mydb的数据复制到temp数据库中</p>
<h5 id="7-修复当前数据库">7. 修复当前数据库</h5>
<p>db.repairDatabase();</p>
<h5 id="8-查看当前使用的数据库">8. 查看当前使用的数据库</h5>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db.getName();
db; db和getName方法是一样的效果，都可以查询当前使用的数据库
</code></pre></div></div>
<h5 id="9-显示当前db状态">9. 显示当前db状态</h5>
<p>db.stats();</p>
<h5 id="10-当前db版本">10. 当前db版本</h5>
<p>db.version();</p>
<h5 id="11-查看当前db的链接机器地址">11. 查看当前db的链接机器地址</h5>
<p>db.getMongo();</p>
<h4 id="collection聚集集合">Collection聚集集合</h4>
<h5 id="1-创建一个聚集集合table">1. 创建一个聚集集合（table）</h5>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db.createCollection(“collName”, {size: 20, capped: 5, max: 100});//创建成功会显示{“ok”:1}
//判断集合是否为定容量db.collName.isCapped();
db.createCollection("tianji_verify"),
</code></pre></div></div>
<h5 id="2-得到指定名称的聚集集合table">2. 得到指定名称的聚集集合（table）</h5>
<p>db.getCollection(“account”);</p>
<h5 id="3-得到当前db的所有聚集集合">3. 得到当前db的所有聚集集合</h5>
<p>db.getCollectionNames();</p>
<h5 id="4-显示当前db所有聚集索引的状态">4. 显示当前db所有聚集索引的状态</h5>
<p>db.printCollectionStats();</p>
<h4 id="聚集集合查询">聚集集合查询</h4>
<h5 id="1-查询所有记录">1. 查询所有记录</h5>
<p>db.userInfo.find();</p>

<p>相当于：select* from userInfo;</p>

<p>默认每页显示20条记录，当显示不下的情况下，可以用it迭代命令查询下一页数据。注意：键入it命令不能带“；”
但是你可以设置每页显示数据的大小，用DBQuery.shellBatchSize= 50;这样每页就显示50条记录了。</p>
<h5 id="2-条件查询">2. 条件查询</h5>
<blockquote>
  <p>查询age = 22的记录</p>
</blockquote>

<p>db.userInfo.find({“age”: 22});</p>

<p>相当于： select * from userInfo where age = 22;</p>
<blockquote>
  <p>查询age &gt; 22的记录</p>
</blockquote>

<p>db.userInfo.find({age: {$gt: 22}});</p>

<p>相当于：select * from userInfo where age &gt;22;</p>
<blockquote>
  <p>查询age &lt; 22的记录</p>
</blockquote>

<p>db.userInfo.find({age: {$lt: 22}});</p>

<p>相当于：select * from userInfo where age &lt;22;</p>
<blockquote>
  <p>查询age &gt;= 25的记录</p>
</blockquote>

<p>db.userInfo.find({age: {$gte: 25}});</p>

<p>相当于：select * from userInfo where age &gt;= 25;</p>

<blockquote>
  <p>查询age &lt;= 25的记录</p>
</blockquote>

<p>db.userInfo.find({age: {$lte: 25}});</p>

<blockquote>
  <p>查询age &gt;= 23 并且 age &lt;= 26</p>
</blockquote>

<p>db.userInfo.find({age: {$gte: 23, $lte: 26}});</p>

<blockquote>
  <p>查询name = zhangsan, age = 22的数据</p>
</blockquote>

<p>db.userInfo.find({name: ‘zhangsan’, age: 22});</p>

<p>相当于：select * from userInfo where name = ‘zhangsan’ and age = ‘22’;</p>

<blockquote>
  <p>时间条件
db.user_record.find({apply_time: {$gt: ISODate(“2017-12-11T00:00:00Z”), $lte:ISODate(“2017-12-12T00:00:00Z”)}})</p>
</blockquote>

<h5 id="3-or与-查询">3. or与 查询</h5>

<p>db.userInfo.find({$or: [{age: 22}, {age: 25}]});</p>

<p>相当于：select * from userInfo where age = 22 or age = 25;</p>

<h5 id="4-模糊匹配">4. 模糊匹配</h5>
<blockquote>
  <p>查询name中包含mongo的数据</p>
</blockquote>

<p>db.userInfo.find({name: /mongo/});</p>

<p>相当于: %% [sql]select * from userInfo where name like ‘%mongo%’;</p>
<blockquote>
  <p>查询name中以mongo开头的</p>
</blockquote>

<p>db.userInfo.find({name: /^mongo/});</p>

<p>相当于：select * from userInfo where name like ‘mongo%’;</p>
<blockquote>
  <p>正则匹配</p>
</blockquote>

<p>db.user_record.find(user_id:{$regex:”rstxjd.*”}})</p>

<h5 id="5-结果过滤">5. 结果过滤</h5>
<blockquote>
  <p>查询指定列name、age数据</p>
</blockquote>

<p>db.userInfo.find({}, {name: 1, age: 1});</p>

<p>相当于: select name, age from userInfo;</p>

<p>当然name也可以用true或false,当用ture的情况下河name:1效果一样，如果用false就是排除name，显示name以外的列信息。</p>
<blockquote>
  <p>查询指定列name、age数据, age &gt; 25</p>
</blockquote>

<p>db.userInfo.find({age: {$gt: 25}}, {name: 1, age: 1});</p>

<p>相当于：select name, age from userInfo where age &gt;25;</p>

<blockquote>
  <p>查询第一条数据</p>
</blockquote>

<p>db.userInfo.findOne();</p>

<p>db.userInfo.find().limit(1);</p>

<p>相当于：selecttop 1 * from userInfo;</p>

<blockquote>
  <p>查询前5条数据</p>
</blockquote>

<p>db.userInfo.find().limit(5);</p>

<p>相当于：selecttop 5 * from userInfo;</p>

<blockquote>
  <p>查询10条以后的数据</p>
</blockquote>

<p>db.userInfo.find().skip(10);</p>

<p>相当于：select * from userInfo where id not in (selecttop 10 * from userInfo);</p>

<blockquote>
  <p>查询在5-10之间的数据</p>
</blockquote>

<p>db.userInfo.find().limit(10).skip(5);</p>

<p>可用于分页，limit是pageSize，skip是第几页*pageSize</p>

<h5 id="6-结果排序">6. 结果排序</h5>

<p>升序：db.userInfo.find().sort({age: 1});</p>

<p>降序：db.userInfo.find().sort({age: -1});</p>

<h5 id="7-结果去重">7. 结果去重</h5>
<p>db.userInfo.distinct(“name”);</p>

<p>会过滤掉name中的相同数据</p>

<p>相当于：select distict(name) from userInfo;</p>

<h5 id="8-结果数量统计">8. 结果数量统计</h5>

<blockquote>
  <p>普通计数</p>
</blockquote>

<p>db.userInfo.find({age: {$gte: 25}}).count();</p>

<p>相当于：select count(*) from userInfo where age &gt;= 20;</p>

<blockquote>
  <p>按照某列进行计数</p>
</blockquote>

<p>db.userInfo.find({sex: {$exists: true}}).count();</p>

<p>相当于：select count(sex) from userInfo;</p>

<h4 id="索引">索引</h4>
<h5 id="1-创建索引">1. 创建索引</h5>
<p>db.userInfo.ensureIndex({name: 1});</p>

<p>db.userInfo.ensureIndex({name: 1, ts: -1});</p>

<h5 id="2-查询当前聚集集合所有索引">2. 查询当前聚集集合所有索引</h5>
<p>db.userInfo.getIndexes();</p>

<h5 id="3-查看总索引记录大小">3. 查看总索引记录大小</h5>
<p>db.userInfo.totalIndexSize();</p>

<h5 id="4-读取当前集合的所有index信息">4. 读取当前集合的所有index信息</h5>
<p>db.users.reIndex();</p>

<h5 id="5-删除指定索引">5. 删除指定索引</h5>
<p>db.users.dropIndex(“name_1”);</p>

<h4 id="修改添加删除集合数据">修改、添加、删除集合数据</h4>
<h5 id="1-添加">1. 添加</h5>

<p>db.users.save({name: ‘zhangsan’, age: 25, sex: true});</p>

<p>添加的数据的数据列，没有固定，根据添加的数据为准</p>
<h5 id="2-修改">2. 修改</h5>

<p>db.users.update({age: 25}, {$set: {name: ‘changeName’}}, false, true);</p>

<p>相当于：update users set name = ‘changeName’ where age = 25;</p>

<p>db.users.update({name: ‘Lisi’}, {$inc: {age: 50}}, false, true);</p>

<p>相当于：update users set age = age + 50 where name = ‘Lisi’;</p>

<p>db.users.update({name: ‘Lisi’}, {$inc: {age: 50}, $set: {name: ‘hoho’}}, false, true);</p>

<p>相当于：update users set age = age + 50, name = ‘hoho’ where name = ‘Lisi’;</p>

<h5 id="3-删除">3. 删除</h5>

<p>db.users.remove({age: 132});</p>

<h5 id="4-查询修改删除">4. 查询修改删除</h5>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db.users.findAndModify({
    query: {age: {$gte: 25}}, 
    sort: {age: -1}, 
    update: {$set: {name: 'a2'}, $inc: {age: 2}},
    remove: true
});
db.runCommand({ findandmodify : "users", 
    query: {age: {$gte: 25}}, 
    sort: {age: -1}, 
    update: {$set: {name: 'a2'}, $inc: {age: 2}},
    remove: true
});
</code></pre></div></div>

<p>update 或 remove 其中一个是必须的参数; 其他参数可选。
参数 |详解 | 默认值
—|—|—
query | 查询过滤条件 | {} 
sort | 如果多个文档符合查询过滤条件，将以该参数指定的排列方式选择出排在首位的对象，该对象将被操作 | {} 
remove | 若为true，被选中对象将在返回前被删除 | N/A 
update | 一个 修改器对象 | N/A 
new	| 若为true，将返回修改后的对象而不是原始对象。在删除操作中，该参数被忽略。 | false 
fields | 参见Retrieving a Subset of Fields (1.5.0+) | All fields 
upsert | 创建新对象若查询结果为空。示例 (1.5.4+) | false</p>

<h4 id="语句块操作">语句块操作</h4>
<h5 id="1-简单hello-world">1. 简单Hello World</h5>
<p>print(“Hello World!”);</p>

<p>这种写法调用了print函数，和直接写入”Hello World!”的效果是一样的；</p>
<h5 id="2-将一个对象转换成json">2. 将一个对象转换成json</h5>
<p>tojson(new Object());</p>

<p>tojson(new Object(‘a’));</p>

<h5 id="3-循环添加数据">3. 循环添加数据</h5>
<blockquote>
  <p>这样就循环添加了30条数据，同样也可以省略括号的写法</p>
  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for (var i = 0; i &lt; 30; i++) {
db.users.save({name: "u_" + i, age: 22 + i, sex: i % 2});
};
</code></pre></div>  </div>
  <p>也是可以的，当你用db.users.find()查询的时候，显示多条数据而无法一页显示的情况下，可以用it查看下一页的信息；</p>
  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for (var i = 0; i &lt; 30; i++) db.users.save({name: "u_" + i, age: 22 + i, sex: i % 2});
</code></pre></div>  </div>
</blockquote>

<h5 id="4-find-游标查询">4. find 游标查询</h5>
<blockquote>
  <p>这样就查询所有的users信息，同样可以这样写</p>
  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var cursor = db.users.find();
while (cursor.hasNext()) { 
    printjson(cursor.next()); 
}
</code></pre></div>  </div>
  <p>同样可以省略{}号</p>
  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var cursor = db.users.find();
while (cursor.hasNext()) { printjson(cursor.next); }
</code></pre></div>  </div>
  <h5 id="5-foreach迭代循环">5. forEach迭代循环</h5>
  <p>db.users.find().forEach(printjson);</p>
</blockquote>

<p>forEach中必须传递一个函数来处理每条迭代的数据信息</p>
<h5 id="6-将find游标当数组处理">6. 将find游标当数组处理</h5>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var cursor = db.users.find();
cursor[4];
</code></pre></div></div>
<p>取得下标索引为4的那条数据
既然可以当做数组处理，那么就可以获得它的长度：cursor.length();或者cursor.count();
那样我们也可以用循环显示数据:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for (var i = 0, len = c.length(); i &lt; len; i++) printjson(c[i]);
</code></pre></div></div>
<h5 id="7-将find游标转换成数组">7. 将find游标转换成数组</h5>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; var arr = db.users.find().toArray();
&gt; printjson(arr[2]);
</code></pre></div></div>
<p>用toArray方法将其转换为数组</p>
<h5 id="8-定制我们自己的查询结果">8. 定制我们自己的查询结果</h5>
<p>只显示age &lt;= 28的并且只显示age这列数据:</p>

<p>db.users.find({age: {$lte: 28}}, {age: 1}).forEach(printjson);</p>

<p>db.users.find({age: {$lte: 28}}, {age: true}).forEach(printjson);</p>

<p>排除age的列:</p>

<p>db.users.find({age: {$lte: 28}}, {age: false}).forEach(printjson);</p>

<h5 id="9-foreach传递函数显示信息">9. forEach传递函数显示信息</h5>

<p>db.things.find({x:4}).forEach(function(x) {print(tojson(x));});</p>

<h4 id="其他">其他</h4>
<h5 id="1-查询之前的错误信息">1. 查询之前的错误信息</h5>

<p>db.getPrevError();</p>

<h5 id="2-清除错误记录">2. 清除错误记录</h5>

<p>db.resetError();</p>

<h5 id="3-查看聚集集合基本信息">3. 查看聚集集合基本信息</h5>
<ul>
  <li>查看帮助  db.yourColl.help();</li>
  <li>查询当前集合的数据条数  db.yourColl.count();</li>
  <li>查看数据空间大小 db.userInfo.dataSize();</li>
  <li>得到当前聚集集合所在的db db.userInfo.getDB();</li>
  <li>得到当前聚集的状态 db.userInfo.stats();</li>
  <li>得到聚集集合总大小 db.userInfo.totalSize();</li>
  <li>聚集集合储存空间大小 db.userInfo.storageSize();</li>
  <li>Shard版本信息  db.userInfo.getShardVersion()</li>
  <li>聚集集合重命名 db.userInfo.renameCollection(“users”); 将userInfo重命名为users</li>
  <li>删除当前聚集集合 db.userInfo.drop();</li>
</ul>
